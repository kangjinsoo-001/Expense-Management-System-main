# 결재선 시스템 요구사항 문서 (PRD)

## 1. 개요
사용자가 경비 청구 시 필요한 승인 프로세스를 관리하기 위한 결재선 시스템을 구축한다.
사용자는 미리 결재선을 정의하고, 경비 항목 추가 시 해당 결재선을 적용하여 순차적 승인을 받을 수 있다.

## 2. 핵심 기능

### 2.1 결재선 관리
- 각 사용자는 자신만의 결재선을 여러 개 생성/관리할 수 있다
- 결재선은 다음 정보를 포함한다:
  - 결재선 소유자 (생성한 사용자)
  - 결재선 이름 (예: "야근용", "회식용", "출장용")
  - 단계별 승인자 목록과 각 승인자의 역할
- 결재선 생성 시 단계를 추가하고 각 단계마다 다음을 지정한다:
  - 승인자 (단일 또는 복수)
  - 각 승인자의 역할:
    - 승인: 결재 권한을 가지고 승인/반려 가능
    - 참조: 승인 권한 없이 열람만 가능, 결재 진행 중 즉시 확인 가능
  - 같은 단계에 승인자가 여러 명인 경우 승인 방식:
    - 전체 승인 필요: 해당 단계의 모든 승인자가 승인해야 다음 단계로 진행
    - 단일 승인 가능: 해당 단계의 승인자 중 1명만 승인해도 다음 단계로 진행
- 같은 단계에 여러 명을 지정할 수 있으며, 승인자와 참조자 혼합 가능
- 결재선은 수정/삭제가 가능하다
- 메인 메뉴의 "결재선" 메뉴로 추가한다.

### 2.2 경비 항목에 결재선 적용
- 경비 항목 추가/수정 시 결재가 필요한 경우 자신이 만든 결재선을 선택할 수 있다
- 결재선이 적용된 경비 항목은 순차적으로 승인을 받아야 한다
- 결재선 적용은 경비 항목별로 선택적이다 (모든 경비가 결재를 필요로 하지 않음)

### 2.3 승인 대기 목록
- 모든 사용자는 자신이 승인해야 할 항목 목록을 볼 수 있는 메뉴가 있다
- 역할에 따른 표시:
  - 승인자: 이전 단계가 모두 승인 완료되어 현재 자신의 차례인 항목만 표시
  - 참조자: 결재가 시작되면 즉시 참조 가능한 항목 표시
- 승인 대기 목록에서는 다음 정보를 확인할 수 있다:
  - 신청자 정보
  - 경비 항목 상세 (경비코드, 금액, 날짜, 설명 등)
  - 결재 진행 상태 (전체 승인자 목록과 각각의 상태)
  - 자신의 역할 표시 (승인/참조)
  - 같은 단계에 다른 승인자가 있는 경우, 승인 방식 표시 (전체 승인 필요/단일 승인 가능)
- 메인 메뉴의 "결재" 메뉴로 추가한다.

### 2.4 승인/반려 처리
- 역할별 처리 권한:
  - 승인자: 승인 또는 반려 가능
  - 참조자: 열람만 가능 (승인/반려 권한 없음)
- 승인 시:
  - 전체 승인 필요 방식: 해당 단계의 모든 승인자가 승인해야 다음 단계로 진행
  - 단일 승인 가능 방식: 승인자 중 1명이 승인하면 다음 단계로 진행
  - 선택적으로 의견을 남길 수 있다
- 반려 시:
  - 반려 사유를 필수로 입력해야 한다
  - 신청자에게 반려 통보가 된다
  - 해당 경비 항목의 결재 프로세스가 중단된다
  - 전체 승인 필요 방식에서는 1명이라도 반려하면 전체 결재가 중단된다

### 2.5 결재 상태 확인
- 신청자는 자신이 신청한 경비 항목의 결재 진행 상태를 확인할 수 있다
- 경비 시트 목록에서 간략한 상태 표시 (예: "결재진행중 - 백승아")
- 상세 화면에서 전체 결재선과 각 단계별 상태 확인 가능:
  - 대기중/승인/반려 상태
  - 승인/반려 일시
  - 승인자의 의견/반려 사유

## 3. 상세 요구사항

### 3.1 결재선 생성/편집 화면
- 결재선 이름 입력
- 단계 추가/삭제 기능
- 각 단계별 설정:
  - 승인자 선택 (사용자 검색 기능 포함 --> 경비 항목 생성의 구성원 선택 인터페이스 choice.js 참고)
  - 각 승인자의 역할 지정 (승인/참조)
  - 같은 단계에 여러 명 추가 가능 (예: 1차에 승인 2명, 참조 1명)
  - 같은 단계에 승인자가 복수인 경우 승인 방식 선택:
    - 전체 승인 필요 (기본값)
    - 단일 승인 가능
- 단계 순서 변경 기능 (드래그 앤 드롭 또는 위/아래 버튼)
- 중복 승인자 체크 (같은 사람이 여러 단계에 있으면 경고)
- 역할별 시각적 구분 (아이콘 또는 색상으로 표시)

### 3.2 경비 항목 폼
- 결재선 선택 칩 (자신이 만든 결재선 목록이 칩으로 모두 나오고 선택 가능)
- 선택한 결재선의 승인자 미리보기 (위 선택에 따라 자동으로 미리보기)
  - 단계별로 승인자 역할과 함께 표시
  - 예: 1차: 최효진(승인), 백승아(참조) / 2차: 박재현(승인) 
- 경비 코드/항목에 따른 결재선 밸리데이션 필요 (예: 회식의 경우 대표이사가 결재선에 포함되어 있는지?) --> 추후 개발 예정

### 3.3 승인 대시보드
- 승인 대기 항목 수 표시
- 필터링 기능 (날짜, 신청자, 금액 범위 등)
- 일괄 승인 기능 (선택한 항목들을 한번에 승인)
- 승인 이력 조회 (과거에 승인/반려한 항목들)

### 3.4 알림 기능 --> 추후 개발 예정 (승인 결재 기능 완료 이후)
- 승인 요청이 왔을 때 알림
- 승인/반려 처리되었을 때 신청자에게 알림
- 이메일 알림 옵션

## 4. 데이터 모델

### 4.1 ApprovalLine (결재선)
- user_id: 소유자
- name: 결재선 이름
- is_active: 활성화 여부
- created_at, updated_at

### 4.2 ApprovalLineStep (결재선 단계)
- approval_line_id: 결재선 ID
- approver_id: 승인자 사용자 ID
- step_order: 단계 순서 (1, 2, 3...)
- role: 역할 (approve/reference) - 승인/참조
- approval_type: 승인 방식 (all_required/single_allowed) - 전체 승인 필요/단일 승인 가능
- created_at, updated_at

### 4.3 ApprovalRequest (승인 요청)
- expense_item_id: 경비 항목 ID
- approval_line_id: 적용된 결재선 ID
- current_step: 현재 진행 단계
- status: 진행중/완료/반려/취소
- created_at, updated_at

### 4.4 ApprovalHistory (승인 이력)
- approval_request_id: 승인 요청 ID
- approver_id: 승인자 ID
- step_order: 단계
- role: 처리 당시 역할 (approve/reference)
- action: 승인/반려/열람
- comment: 의견/반려사유
- approved_at: 처리 일시

## 5. UI/UX 고려사항
- 결재선 선택 시 즉시 승인자 목록을 확인할 수 있도록 표시
- 승인 대기 항목은 급한 순서대로 정렬 (신청일 오래된 순)
- 모바일에서도 쉽게 승인/반려할 수 있도록 반응형 디자인
- 결재 진행 상태를 시각적으로 표현 (프로그레스 바, 체크 아이콘 등)
- 역할별 아이콘/색상 구분:
  - 승인자: 체크 아이콘 (파란색)
  - 참조자: 눈 아이콘 (회색)
- 승인 방식 표시:
  - 전체 승인 필요: 사람 아이콘 여러 개
  - 단일 승인 가능: 사람 아이콘 하나
- 같은 단계에서 여러 승인자의 진행 상황 표시

## 6. 성능 요구사항
- 승인 대기 목록은 실시간으로 업데이트되어야 함
- 대량의 승인 요청이 있어도 빠르게 로딩되어야 함
- 동시에 여러 승인자가 같은 항목을 처리하려 할 때 충돌 방지
- 전체 승인 필요 방식에서 여러 승인자가 동시에 처리할 때 동시성 제어

## 7. 보안 요구사항
- 자신이 승인자로 지정된 항목만 승인/반려 가능
- 결재선은 소유자만 수정/삭제 가능
- 승인 이력은 수정 불가능하도록 처리

## 8. 추후 확장 고려사항
- 조직도 기반 자동 결재선 생성 기능
- 대리 승인자 지정 기능
- 조건부 결재선 (금액에 따라 다른 결재선 적용)
- 결재선 템플릿 공유 기능
- 전결 기능 (특정 조건 충족 시 중간 단계 건너뛰기)
- 후결 기능 (사후 승인)
- 공람 기능 (결재 완료 후 추가 열람자 지정)