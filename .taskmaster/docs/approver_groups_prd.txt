# 승인자 그룹 시스템 요구사항 문서

## 개요
경비 코드별로 필수 승인자를 지정할 수 있는 승인자 그룹 시스템을 구축한다. 승인자 그룹은 특정 직책이나 역할을 가진 사용자들의 집합으로, 경비 신청 시 결재선에 반드시 포함되어야 하는 승인자를 정의한다.

## 핵심 기능

### 1. 승인자 그룹 관리
- 승인자 그룹 생성/수정/삭제
- 그룹명 (예: C-Level, 팀장, CEO)
- 그룹 설명
- 그룹 우선순위 (1~10, 숫자가 높을수록 상위 권한)
- 그룹 멤버 관리 (사용자를 그룹에 추가/제거)
- 활성화/비활성화 상태 관리

### 2. 승인자 그룹 간 위계 관리
- 우선순위 기반 위계 시스템
- 상위 그룹이 결재선에 포함되면 하위 그룹 요구사항 자동 충족
- 예: CEO(우선순위 10) > C-Level(우선순위 8) > 팀장(우선순위 5)
- 결재선에 CEO가 포함되면 C-Level, 팀장 요구사항 모두 충족

### 3. 경비 코드별 승인 조건 설정
- 어드민이 관리자 메뉴에서 각 경비 코드에 조건부 승인자 그룹 요구사항 설정
- 조건식 기반 설정 (금액, 날짜, 커스텀 필드 등)
- 예시:
  - "#금액 > 300000" → CEO 그룹 필수
  - "#금액 <= 300000" → C-Level 그룹 필수
  - "#참석인원 > 10" → 부서장 그룹 필수

### 4. 결재선 검증
- 일반 사용자가 경비 항목 생성/수정 시 선택한 결재선을 확인하여 승인자 조건에 맞는지 검증
- 필수 승인자 그룹 포함 여부 확인
- 위계를 고려한 자동 검증
- 조건에 맞지 않는 경우 에러 메시지 표시

## 데이터 모델

### ApproverGroup (승인자 그룹)
- name: 그룹명
- description: 설명
- priority: 우선순위 (1~10)
- is_active: 활성화 여부
- created_by: 생성자 (User)

### ApproverGroupMember (그룹 멤버)
- approver_group_id: 승인자 그룹
- user_id: 사용자
- added_by: 추가한 관리자
- added_at: 추가 일시

### ExpenseCodeApprovalRule (경비 코드 승인 규칙)
- expense_code_id: 경비 코드
- condition: 조건식 (예: "#금액 > 300000")
- approver_group_id: 필수 승인자 그룹
- order: 규칙 순서
- is_active: 활성화 여부

## 사용자 인터페이스

### 관리자 메뉴
1. 승인자 그룹 관리
   - 그룹 목록 (우선순위순 정렬)
   - 그룹 생성/수정/삭제
   - 그룹 멤버 관리 (사용자 추가/제거)

2. 경비 코드 관리 확장
   - 각 경비 코드 생성/수정 화면에서 승인 규칙 영역 추가
   - 조건식 입력 UI
   - 승인자 그룹 선택 UI
   - 규칙 미리보기

### 경비 항목 생성/수정
- 결재선 선택 시 실시간 검증
- 필수 승인자 그룹 미충족 시 경고 메시지
- 자동으로 충족된 그룹 표시
- 현재 선택한 결재선의 각 승인자가 어떤 승인자 그룹인지 표시

## 기술 요구사항

### 조건식 파서
- Ruby 기반 조건식 평가 엔진
- 지원 연산자: >, <, >=, <=, ==, !=
- 지원 필드: #금액, #날짜, #커스텀필드명
- 안전한 평가를 위한 샌드박스 환경

### 성능 고려사항
- 승인자 그룹 멤버십 캐싱
- 조건식 평가 결과 캐싱
- 위계 계산 최적화

### 보안 고려사항
- 관리자만 승인자 그룹 관리 가능
- 조건식 인젝션 방지
- 감사 로그 (그룹 변경 이력)

## 구현 우선순위

1단계: 승인자 그룹 기본 기능
- 승인자 그룹 CRUD
- 그룹 멤버 관리
- 우선순위 시스템

2단계: 경비 코드 통합
- 승인 규칙 설정 UI
- 조건식 파서 구현
- 결재선 검증 로직

3단계: 고급 기능
- 복잡한 조건식 지원
- 승인자 그룹 이력 관리
- 대시보드 통계

## 예상 효과
- 경비 신청 시 적절한 승인자 자동 확인
- 금액별, 조건별 유연한 승인 정책 수립
- 컴플라이언스 강화
- 승인 프로세스 자동화