<!-- AI 검증 작업 내용 요약 -->
<% 
  # validation_result가 있거나 validation_histories가 있으면 표시
  has_validation = expense_sheet.validation_result.present? || expense_sheet.validation_histories.any?
  
  if has_validation
    # ValidationHistory에서 컨텍스트 가져오기 (우선)
    last_validation_history = expense_sheet.validation_histories.last
    
    # 1. ValidationHistory의 full_validation_context 사용
    # 2. 없으면 캐시에서 가져오기
    # 3. 둘 다 없으면 빈 해시
    context = if last_validation_history&.full_validation_context.present?
                last_validation_history.full_validation_context
              else
                context_key = "validation_context_#{expense_sheet.id}_#{current_user.id}"
                Rails.cache.read(context_key) || {}
              end
    
    # 검증 시간 결정
    validation_time = if expense_sheet.validated_at.present?
      expense_sheet.validated_at
    elsif expense_sheet.validation_histories.any?
      expense_sheet.validation_histories.last.created_at
    else
      Time.current
    end
    
    # 필요한 데이터 준비 (HashWithIndifferentAccess로 Symbol/String 키 모두 처리)
    step_3_data = HashWithIndifferentAccess.new(context["step_3"] || {})
    step_4_data = HashWithIndifferentAccess.new(context["step_4"] || {})
    
    # 법인카드 거래 내역
    card_transactions = []
    if step_3_data[:debug_info] && step_3_data[:debug_info][:gemini_request]
      card_transactions = step_3_data[:debug_info][:gemini_request][:card_transactions] || []
    end
    
    # 영수증 관련 데이터
    receipt_check = step_4_data[:receipt_check] || {}
    items_missing = receipt_check[:items_missing_receipts] || []
    items_needing = receipt_check[:items_needing_receipts] || []
    
    # 3단계에서 식별된 영수증 필요 항목도 확인
    if items_needing.empty? && step_3_data[:suggested_order]
      suggested_order = step_3_data[:suggested_order]
      if suggested_order
        items_needing = suggested_order[:items_needing_receipts] || []
      end
    end
    
    # 영수증 필요 항목 ID 목록
    receipt_needed_ids = items_needing.map { |r| r['item_id'].to_i }
    
    # 항목들을 3개 그룹으로 분류
    sorted_items = expense_items.reject(&:is_draft?).sort_by(&:position)
    telecom_items = sorted_items.select { |item| item.expense_code.code == "EC002" }
    receipt_needed_items = sorted_items.select { |item| receipt_needed_ids.include?(item.id) }
    card_matched_items = sorted_items - telecom_items - receipt_needed_items
    
    # 토큰 사용량 및 비용 (모든 단계 합산)
    total_token_usage = { 'total_tokens' => 0, 'prompt_tokens' => 0, 'completion_tokens' => 0 }
    total_cost_krw = 0.0
    
    # 각 단계의 토큰 사용량 합산
    (1..4).each do |step|
      step_data = HashWithIndifferentAccess.new(context["step_#{step}"] || {})
      if step_data[:token_usage].present?
        total_token_usage['total_tokens'] += (step_data[:token_usage]['total_tokens'] || step_data[:token_usage][:total_tokens] || 0)
        total_token_usage['prompt_tokens'] += (step_data[:token_usage]['prompt_tokens'] || step_data[:token_usage][:prompt_tokens] || 0)
        total_token_usage['completion_tokens'] += (step_data[:token_usage]['completion_tokens'] || step_data[:token_usage][:completion_tokens] || 0)
      end
      if step_data[:cost_krw].present?
        total_cost_krw += step_data[:cost_krw].to_f
      end
    end
    
    # 토큰 사용량이 있으면 표시용 변수 설정
    token_usage = total_token_usage if total_token_usage['total_tokens'] > 0
    cost_krw = total_cost_krw > 0 ? total_cost_krw.round(1) : nil
%>
    <div class="bg-white shadow-sm rounded-lg mb-6">
      <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <h3 class="text-lg font-medium leading-6 text-gray-900">
          <span class="text-xl mr-2">🤖</span>AI 검증 결과
        </h3>
        <p class="mt-1 text-sm text-gray-500">
          검증 완료: <%= validation_time.strftime("%Y-%m-%d %H:%M") %>
        </p>
      </div>
      <div class="p-6 space-y-6">

        <!-- 1. 법인카드 명세서 요약 -->
        <% if card_transactions.any? %>
            <div class="bg-gray-50 rounded-lg p-4">
              <h5 class="font-medium text-gray-900 mb-3">
                <span class="text-lg mr-2">💳</span>법인카드 명세서 요약
              </h5>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead>
                    <tr>
                      <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">번호</th>
                      <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">날짜</th>
                      <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase">가맹점</th>
                      <th class="px-2 py-1 text-right text-xs font-medium text-gray-500 uppercase">금액</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100">
                    <% card_transactions.each_with_index do |transaction, index| %>
                      <tr class="text-sm">
                        <td class="px-2 py-1 text-gray-600"><%= index + 1 %></td>
                        <td class="px-2 py-1 text-gray-700"><%= transaction[:date] %></td>
                        <td class="px-2 py-1 text-gray-700"><%= transaction[:merchant] || transaction[:description] || '-' %></td>
                        <td class="px-2 py-1 text-right font-medium text-gray-900"><%= format_currency(transaction[:amount]) %></td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          <% end %>

        <!-- 2. 명세서 순서 검증 내역 -->
        <div class="bg-blue-50 rounded-lg p-4">
          <h5 class="font-medium text-gray-900 mb-3">
            <span class="text-lg mr-2">🔄</span>명세서 순서 검증 내역
          </h5>
          <p class="text-sm text-gray-600 mb-3">경비 항목을 법인카드 명세서 순서에 맞춰 재정렬했습니다.</p>
          <ol class="space-y-1 ml-6 text-sm text-gray-700">
              
              <!-- 통신비 (최상단) -->
              <% if telecom_items.any? %>
                <% telecom_items.each_with_index do |item, index| %>
                  <li>
                    <span class="font-medium">위치 <%= item.position %>:</span> 
                    [<%= item.expense_date.strftime("%-m/%-d") %>] 
                    <%= item.expense_code.name %>
                    <% if item.description.present? %>
                      - <%= item.description %>
                    <% end %>
                    - <%= format_currency(item.amount) %>
                    <span class="text-green-600 font-medium">✅ (통신비 최상단)</span>
                  </li>
                <% end %>
              <% end %>
              
              <!-- 법인카드 매칭 항목들 -->
              <% if card_matched_items.any? %>
                <% card_matched_items.each do |item| %>
                  <li>
                    <span class="font-medium">위치 <%= item.position %>:</span> 
                    [<%= item.expense_date.strftime("%-m/%-d") %>] 
                    <%= item.expense_code.name %>
                    <% if item.description.present? %>
                      - <%= item.description %>
                    <% end %>
                    - <%= format_currency(item.amount) %>
                    <span class="text-blue-600 font-medium">💳 (법인카드)</span>
                  </li>
                <% end %>
              <% end %>
              
              <!-- 영수증 필요 항목들 (맨 뒤) -->
              <% if receipt_needed_items.any? %>
                <% receipt_needed_items.each do |item| %>
                  <li>
                    <span class="font-medium">위치 <%= item.position %>:</span> 
                    [<%= item.expense_date.strftime("%-m/%-d") %>] 
                    <%= item.expense_code.name %>
                    <% if item.description.present? %>
                      - <%= item.description %>
                    <% end %>
                    - <%= format_currency(item.amount) %>
                    <span class="text-amber-600 font-medium">📎 (개인 경비 - 영수증 필요)</span>
                  </li>
                <% end %>
              <% end %>
          </ol>
        </div>

        <!-- 3. 추가 영수증 검증 내역 -->
        <% if items_needing.any? || items_missing.any? %>
          <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <h5 class="font-medium text-gray-900 mb-3">
              <span class="text-lg mr-2">📎</span>추가 영수증 검증 내역
            </h5>
              
              <!-- 영수증이 필요한 항목들 -->
              <% if items_needing.any? %>
                <div class="mb-3">
                  <p class="text-sm font-medium text-gray-700 mb-2">
                    법인카드 명세서에 없는 항목 (<%= items_needing.size %>개) - 영수증 필수:
                  </p>
                  <ul class="space-y-1 ml-4">
                    <% items_needing.each do |item| %>
                      <% 
                        expense_item = expense_items.find { |ei| ei.id == item['item_id'].to_i }
                        has_attachment = expense_item&.expense_attachments&.any?
                        is_missing = items_missing.any? { |m| m['item_id'].to_i == item['item_id'].to_i }
                      %>
                      <li class="text-sm flex items-start">
                        <span class="<%= has_attachment ? 'text-green-600' : 'text-red-600' %> mr-2">
                          <%= has_attachment ? '✅' : '❌' %>
                        </span>
                        <div class="flex-1">
                          <span class="<%= has_attachment ? 'text-gray-700' : 'text-red-700 font-medium' %>">
                            <%= expense_item&.expense_code&.name || "경비 항목" %> - 
                            <%= item['description'] || expense_item&.description %>
                            (<%= format_currency(item['amount'] || expense_item&.amount) %>)
                          </span>
                          <% if has_attachment %>
                            <span class="text-xs text-green-600 ml-2">영수증 첨부됨</span>
                          <% else %>
                            <span class="text-xs text-red-600 ml-2 font-medium">영수증 미첨부</span>
                          <% end %>
                        </div>
                      </li>
                    <% end %>
                  </ul>
                </div>
              <% end %>
              
              <!-- 영수증이 누락된 항목만 강조 -->
              <% 
                # 실제로 영수증이 누락된 항목만 찾기 (실시간 체크)
                actually_missing = items_needing.select { |item| 
                  expense_item = expense_items.find { |ei| ei.id == item['item_id'].to_i }
                  !expense_item&.expense_attachments&.any?
                }
              %>
              <% if actually_missing.any? %>
                <div class="mt-3 p-2 bg-red-100 border border-red-200 rounded">
                  <p class="text-xs text-red-700 font-medium">
                    ⚠️ 조치 필요: <%= actually_missing.size %>개 항목에 영수증을 첨부해주세요.
                  </p>
                </div>
              <% elsif items_needing.any? %>
                <!-- 영수증이 필요한 항목이 있지만 모두 첨부된 경우만 성공 메시지 -->
                <% all_attached = items_needing.all? { |item| 
                     expense_item = expense_items.find { |ei| ei.id == item['item_id'].to_i }
                     expense_item&.expense_attachments&.any?
                   } %>
                <% if all_attached %>
                  <div class="mt-3 p-2 bg-green-100 border border-green-200 rounded">
                    <p class="text-xs text-green-700 font-medium">
                      ✅ 모든 필수 영수증이 첨부되었습니다.
                    </p>
                  </div>
                <% end %>
              <% end %>
          </div>
        <% end %>
        
        <!-- 4. 토큰 사용량 -->
        <% if token_usage.present? %>
          <div class="bg-purple-50 rounded-lg p-4">
            <h5 class="font-medium text-gray-900 mb-3">
              <span class="text-lg mr-2">⚡</span>토큰 사용량
            </h5>
            <ul class="space-y-1 ml-6 text-sm text-gray-700">
              <li>
                <span class="font-medium">Gemini API 호출:</span> 
                <%= token_usage['total_tokens'] || 0 %> 토큰
              </li>
              <% if token_usage['prompt_tokens'] || token_usage['completion_tokens'] %>
                <li class="ml-4 text-xs text-gray-600">
                  - 프롬프트: <%= token_usage['prompt_tokens'] || 0 %> 토큰
                </li>
                <li class="ml-4 text-xs text-gray-600">
                  - 응답: <%= token_usage['completion_tokens'] || 0 %> 토큰
                </li>
              <% end %>
              <% if cost_krw.present? %>
                <li class="mt-2">
                  <span class="font-medium">→ <%= cost_krw %>원</span>
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>
      </div>
    </div>
<% end %>