<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
  <% if attachment.analysis_result.present? && attachment.analysis_result['summary_data'].present? %>
    <% 
      summary_data = attachment.analysis_result['summary_data']
      
      # JSON 문자열인 경우 파싱
      if summary_data.is_a?(String)
        begin
          summary_data = JSON.parse(summary_data)
        rescue JSON::ParserError
          summary_data = { 'summary_text' => summary_data }
        end
      end
      
      # type과 data 분리
      receipt_type = summary_data['type'] || 'unknown'
      data = summary_data['data'] || summary_data
      
      # transactions가 있으면 corporate_card로 판단
      if receipt_type == 'unknown' && data['transactions'].is_a?(Array)
        receipt_type = 'corporate_card'
      end
    %>
    
    <div class="mb-3">
      <h4 class="text-sm font-semibold text-gray-700 mb-2">AI 요약 결과</h4>
      
      <% case receipt_type %>
      <% when 'corporate_card' %>
        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <span class="text-xs text-gray-500">유형:</span>
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800">
              법인카드 명세서
            </span>
          </div>
          
          <% if data['transactions'].is_a?(Array) %>
            <div class="mt-2">
              <p class="text-xs text-gray-500 mb-1">거래 내역 (<%= data['transactions'].length %>건)</p>
              <div class="overflow-x-auto">
                <table class="min-w-full text-xs">
                  <thead>
                    <tr class="border-b">
                      <th class="text-left px-1 py-1 font-medium text-gray-600">날짜</th>
                      <th class="text-left px-1 py-1 font-medium text-gray-600">가맹점</th>
                      <th class="text-right px-1 py-1 font-medium text-gray-600">금액</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% data['transactions'].first(5).each do |tx| %>
                      <tr class="border-b">
                        <td class="px-1 py-1"><%= tx['date'] || '' %></td>
                        <td class="px-1 py-1"><%= (tx['merchant'] || tx['vendor'] || tx['description'] || '').truncate(20) %></td>
                        <td class="text-right px-1 py-1">₩<%= number_with_delimiter(tx['total'] || tx['amount'] || 0) %></td>
                      </tr>
                    <% end %>
                    <% if data['transactions'].length > 5 %>
                      <tr>
                        <td colspan="3" class="px-1 py-1 text-center text-gray-500">
                          ... <%= data['transactions'].length - 5 %>건 더
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                  <tfoot>
                    <tr class="font-bold border-t-2">
                      <td colspan="2" class="px-1 py-1">합계</td>
                      <td class="text-right px-1 py-1 text-blue-600">
                        ₩<%= number_with_delimiter(data['grand_total'] || data['total_amount'] || data['transactions'].sum { |t| t['total'] || t['amount'] || 0 }) %>
                      </td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          <% end %>
        </div>
        
      <% when 'telecom' %>
        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <span class="text-xs text-gray-500">유형:</span>
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
              통신비 영수증
            </span>
          </div>
          
          <% if data['total_amount'] %>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-500">전체 청구 금액:</span>
              <span class="text-sm font-semibold text-gray-900">
                <%= number_to_currency(data['total_amount'], unit: "₩", precision: 0, format: "%u%n") %>
              </span>
            </div>
          <% end %>
          
          <% if data['billing_period'] || data['billing_month'] %>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-500">청구 기간:</span>
              <span class="text-sm text-gray-700"><%= data['billing_period'] || data['billing_month'] %></span>
            </div>
          <% end %>
        </div>
        
      <% when 'general' %>
        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <span class="text-xs text-gray-500">유형:</span>
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
              일반 영수증
            </span>
          </div>
          
          <% if data['store_name'] || data['vendor'] %>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-500">상호명:</span>
              <span class="text-sm font-medium text-gray-900"><%= data['store_name'] || data['vendor'] %></span>
            </div>
          <% end %>
          
          <% if data['total_amount'] || data['amount'] %>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-500">전체 금액:</span>
              <span class="text-sm font-semibold text-gray-900">
                <%= number_to_currency(data['total_amount'] || data['amount'], unit: "₩", precision: 0, format: "%u%n") %>
              </span>
            </div>
          <% end %>
          
          <% if data['date'] %>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-500">거래일:</span>
              <span class="text-sm text-gray-700"><%= data['date'] %></span>
            </div>
          <% end %>
        </div>
        
      <% else %>
        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <span class="text-xs text-gray-500">유형:</span>
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
              기타 문서
            </span>
          </div>
          
          <% if data['summary_text'] %>
            <div class="text-sm text-gray-700">
              <%= data['summary_text'] %>
            </div>
          <% elsif data.is_a?(Hash) %>
            <div class="text-xs text-gray-600">
              <% data.each do |key, value| %>
                <% next if key == 'type' %>
                <div class="flex justify-between">
                  <span><%= key.humanize %>:</span>
                  <span><%= value %></span>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
    
    <% if attachment.extracted_text.present? %>
      <details class="mt-3 pt-3 border-t border-gray-200">
        <summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-700">
          원본 텍스트 보기
        </summary>
        <div class="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600 max-h-40 overflow-y-auto">
          <%= simple_format(attachment.extracted_text.truncate(1000)) %>
        </div>
      </details>
    <% end %>
    
  <% elsif attachment.extracted_text.present? %>
    <div class="space-y-2">
      <h4 class="text-sm font-semibold text-gray-700">추출된 텍스트</h4>
      <div class="p-3 bg-gray-50 rounded text-sm text-gray-600 max-h-60 overflow-y-auto">
        <%= simple_format(attachment.extracted_text.truncate(1500)) %>
      </div>
    </div>
  <% else %>
    <div class="text-sm text-gray-500">
      아직 처리되지 않았습니다.
    </div>
  <% end %>
</div>