<tr id="expense_item_<%= expense_item.id %>" 
    data-item-id="<%= expense_item.id %>">
    <% if @expense_sheet.editable? %>
      <td class="px-2 py-4 whitespace-nowrap">
        <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 select-none"
             style="user-select: none; -webkit-user-select: none; -moz-user-select: none;">
          <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M9 3h2v2H9V3zm0 4h2v2H9V7zm0 4h2v2H9v-2zm0 4h2v2H9v-2zm0 4h2v2H9v-2zm4-16h2v2h-2V3zm0 4h2v2h-2V7zm0 4h2v2h-2v-2zm0 4h2v2h-2v-2zm0 4h2v2h-2v-2z"/>
          </svg>
        </div>
      </td>
    <% end %>
    <td class="font-medium">
      <%= expense_item.expense_date.strftime("%m/%d") %>
    </td>
    <td>
      <span class="tremor-badge-gray tremor-badge">
        <%= expense_item.expense_code.code %>
      </span>
    </td>
    <td class="text-gray-600">
      <div class="flex items-center gap-2">
        <%= truncate(expense_item.display_description, length: 50) %>
        <% if expense_item.expense_attachments_count > 0 %>
          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
            </svg>
            <%= expense_item.expense_attachments_count %>
          </span>
        <% end %>
      </div>
    </td>
    <td class="text-right font-semibold">
      <%= format_currency(expense_item.amount) %>
    </td>
    <td class="text-center">
      <span class="<%= expense_item.validation_badge_class %> px-2 py-1 text-xs font-medium rounded-full">
        <%= expense_item.validation_status_label %>
      </span>
    </td>
    <td class="text-center">
      <% if expense_item.approval_request.present? %>
        <% 
          approval_request = expense_item.approval_request
          total_steps = approval_request.approval_line.approval_line_steps.pluck(:step_order).uniq.count
          completed_steps = approval_request.approval_histories.where(action: 'approve').pluck(:step_order).uniq.count
          progress_percentage = (completed_steps.to_f / total_steps * 100).round
        %>
        <div class="flex items-center gap-2 justify-center">
          <div class="w-20 bg-gray-200 rounded-full h-1.5 overflow-hidden">
            <div class="h-full rounded-full transition-all duration-300 <%= approval_request.status == 'approved' ? 'bg-green-600' : approval_request.status == 'rejected' ? 'bg-red-600' : 'bg-blue-600' %>"
                 style="width: <%= progress_percentage %>%">
            </div>
          </div>
          <span class="text-xs font-medium text-gray-600"><%= progress_percentage %>%</span>
        </div>
      <% else %>
        <span class="text-xs text-gray-400">-</span>
      <% end %>
    </td>
    <% if @expense_sheet.editable? %>
      <td class="text-center">
        <div class="flex items-center justify-center gap-1">
          <%= link_to edit_expense_sheet_expense_item_path(@expense_sheet, expense_item), 
                      class: "p-1.5 rounded hover:bg-gray-100 transition-colors group",
                      title: "수정" do %>
            <svg class="h-4 w-4 text-gray-500 group-hover:text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          <% end %>
          
          <%= button_to expense_sheet_expense_item_path(@expense_sheet, expense_item), 
                        method: :delete,
                        data: { 
                          turbo_confirm: "정말 삭제하시겠습니까?"
                        },
                        class: "p-1.5 rounded hover:bg-red-50 transition-colors group" do %>
            <svg class="h-4 w-4 text-gray-500 group-hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          <% end %>
        </div>
      </td>
    <% end %>
  </tr>