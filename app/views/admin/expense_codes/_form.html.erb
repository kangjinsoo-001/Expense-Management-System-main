<%= form_with(model: [:admin, expense_code], 
              data: { controller: "expense-code-form" }) do |form| %>
  <% if expense_code.errors.any? %>
    <div class="mb-6 border border-red-200 bg-red-50 rounded-lg p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800"><%= expense_code.errors.count %>개의 오류가 발생했습니다:</h3>
          <ul class="mt-2 list-disc list-inside text-sm text-red-700">
            <% expense_code.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  <% end %>

  <div class="space-y-8">
    <!-- 1. 기본 정보 섹션 -->
    <div class="bg-white shadow-sm rounded-lg p-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">기본 정보</h3>
      <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
        <div class="sm:col-span-1">
          <%= form.label :code, class: "block text-sm font-medium text-gray-700" do %>
            코드 <span class="text-red-500">*</span>
          <% end %>
          <%= form.text_field :code, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", required: true %>
        </div>
        
        <div class="sm:col-span-1">
          <%= form.label :name, class: "block text-sm font-medium text-gray-700" do %>
            이름 <span class="text-red-500">*</span>
          <% end %>
          <%= form.text_field :name, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", required: true %>
        </div>

        <div class="sm:col-span-2">
          <%= form.label :description, "설명", class: "block text-sm font-medium text-gray-700" %>
          <%= form.text_area :description, rows: 3, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
        </div>
        
        <div class="sm:col-span-1">
          <%= form.label :organization_id, "적용 조직", class: "block text-sm font-medium text-gray-700" %>
          <%= form.select :organization_id, 
              options_for_select([["전체", nil]] + Organization.pluck(:name, :id), expense_code.organization_id),
              {},
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
        </div>

        <div class="sm:col-span-1 flex items-end">
          <label class="inline-flex items-center">
            <%= form.check_box :active, class: "rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" %>
            <span class="ml-2 text-sm font-medium text-gray-700">활성화</span>
          </label>
        </div>
        
        <div class="sm:col-span-1 flex items-end">
          <label class="inline-flex items-center">
            <%= form.check_box :attachment_required, class: "rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" %>
            <span class="ml-2 text-sm font-medium text-gray-700">첨부파일 필수</span>
          </label>
        </div>
      </div>
    </div>

    <!-- 2. 필수 필드 섹션 -->
    <div class="bg-white shadow-sm rounded-lg p-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">필수 필드</h3>
      <div data-expense-code-form-target="requiredFields" class="space-y-2">
        <% required_fields = expense_code.required_fields || {} %>
        <% if required_fields.is_a?(Array) %>
          <% # 기존 데이터 호환성을 위한 처리 %>
          <% required_fields.each do |field_name| %>
            <div class="field-row flex items-center gap-2 p-2 bg-gray-50 rounded border border-gray-200">
              <%= text_field_tag nil, field_name,
                  class: "flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500",
                  data: { field_name: field_name },
                  readonly: true %>
              <%= select_tag nil,
                  options_for_select(ExpenseCode::FIELD_TYPES.map { |k, v| [v, k.to_s] }, 'text'),
                  class: "rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500",
                  data: { field_type: true } %>
              <button type="button" class="text-red-600 hover:text-red-900" data-action="click->expense-code-form#removeField">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          <% end %>
        <% else %>
          <% # 새 구조의 데이터 %>
          <% required_fields.each do |field_key, field_config| %>
            <div class="field-row flex flex-col sm:flex-row items-start sm:items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200" 
                 data-field-key="<%= field_key %>"
                 data-saved="true"
                 <% if field_config['options'].present? %>
                   data-options='<%= field_config['options'].to_json %>'
                 <% end %>
                 data-expense-code-form-target="fieldRow">
              <!-- 읽기 모드 (기본값) -->
              <div class="view-mode flex-1 flex flex-wrap items-center gap-2" data-expense-code-form-target="viewMode">
                <span class="font-medium text-gray-900"><%= field_config['label'] || field_key %></span>
                <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800 inline-flex items-center gap-1"
                      data-field-type="<%= field_config['type'] %>">
                  <% case field_config['type'] %>
                  <% when 'text' %>
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                  <% when 'number' %>
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                    </svg>
                  <% when 'participants' %>
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                  <% when 'select' %>
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                  <% when 'organization' %>
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                  <% end %>
                  <%= ExpenseCode::FIELD_TYPES[field_config['type'].to_s.to_sym] || field_config['type'] %>
                </span>
                <% if field_config['required'] != false %>
                  <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">필수</span>
                <% else %>
                  <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">선택</span>
                <% end %>
                <% if field_config['type'] == 'select' && field_config['options'].present? %>
                  <span class="text-xs text-gray-600">(선택지: <%= field_config['options'].join(', ') %>)</span>
                <% end %>
              </div>
              
              <!-- 편집 모드 (숨김) -->
              <div class="edit-mode hidden flex-1" data-expense-code-form-target="editMode">
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                <%= text_field_tag nil, field_config['label'] || field_key,
                    class: "flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500",
                    placeholder: "필드 이름",
                    data: { field_label: true } %>
                <%= select_tag nil,
                    options_for_select(ExpenseCode::FIELD_TYPES.map { |k, v| [v, k.to_s] }, field_config['type'] || 'text'),
                    class: "rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500",
                    data: { field_type: true } %>
                <label class="inline-flex items-center">
                  <%= check_box_tag nil, '1', field_config['required'] != false,
                      class: "rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500",
                      data: { field_required: true } %>
                  <span class="ml-2 text-sm text-gray-600">필수</span>
                </label>
                </div>
                <!-- 선택지 옵션은 여기에 JavaScript로 동적 추가됨 -->
              </div>
              
              <!-- 액션 버튼들 -->
              <div class="action-buttons flex items-center gap-1 flex-shrink-0">
                <!-- 화살표 버튼들 -->
                <button type="button" 
                        class="move-up-btn text-gray-400 hover:text-gray-600 p-1" 
                        data-action="click->expense-code-form#moveFieldUp"
                        title="위로 이동">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                  </svg>
                </button>
                <button type="button" 
                        class="move-down-btn text-gray-400 hover:text-gray-600 p-1" 
                        data-action="click->expense-code-form#moveFieldDown"
                        title="아래로 이동">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                
                <button type="button" 
                        class="edit-btn text-gray-400 hover:text-gray-600 p-1" 
                        data-action="click->expense-code-form#toggleEditMode"
                        title="편집">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </button>
                <button type="button" 
                        class="save-btn hidden text-green-600 hover:text-green-800 p-1" 
                        data-action="click->expense-code-form#saveField"
                        title="저장">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </button>
                <button type="button" 
                        class="cancel-btn hidden text-gray-400 hover:text-gray-600 p-1" 
                        data-action="click->expense-code-form#cancelEdit"
                        title="취소">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
                <button type="button" 
                        class="delete-btn text-red-600 hover:text-red-900 p-1" 
                        data-action="click->expense-code-form#removeField"
                        title="필드 삭제">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
      
      <button type="button" class="mt-3 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" data-action="click->expense-code-form#addField">
        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        필드 추가
      </button>
      
      <!-- 필드 타입 설명 -->
      <div class="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-600">
        <p class="font-medium mb-1">필드 타입 설명:</p>
        <ul class="list-disc list-inside space-y-1 text-xs">
          <li><strong>텍스트:</strong> 일반 텍스트 입력</li>
          <li><strong>숫자:</strong> 숫자만 입력 가능</li>
          <li><strong>구성원:</strong> 구성원 목록 입력 (인원수 계산 가능)</li>
          <li><strong>조직:</strong> 조직 선택</li>
          <li><strong>선택지:</strong> 정의된 선택지 중 하나 선택</li>
        </ul>
      </div>
      
      <!-- 실시간 미리보기 -->
      <div class="mt-6">
        <h4 class="text-sm font-medium text-gray-900 mb-3">사용자 폼 미리보기</h4>
        <div class="bg-gray-50 rounded-lg p-4" data-expense-code-form-target="preview">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">경비 코드</label>
            <div class="p-2 bg-white border border-gray-300 rounded text-sm">
              <%= expense_code.name || "새 경비 코드" %>
            </div>
          </div>
          
          <div class="preview-fields space-y-3" data-expense-code-form-target="previewFields">
            <!-- 동적으로 생성될 필드 미리보기 -->
          </div>
          
          <% if required_fields.empty? %>
            <p class="text-sm text-gray-500 italic">추가 필드가 없습니다.</p>
          <% end %>
        </div>
      </div>
    </div>
    
    <!-- 3. 설명 템플릿 섹션 -->
    <div class="bg-white shadow-sm rounded-lg p-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">설명 템플릿</h3>
      <div>
        <%= form.label :description_template, "템플릿", class: "block text-sm font-medium text-gray-700" %>
        <%= form.text_area :description_template, 
            rows: 3, 
            placeholder: "예: #expense_date에 #구성원와 #사유 진행",
            class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
        
        <div class="mt-3 p-3 bg-gray-50 rounded-lg text-sm text-gray-600">
          <p class="font-medium mb-1">사용 가능한 플레이스홀더:</p>
          <ul class="list-disc list-inside space-y-1 text-xs">
            <li><code>#amount</code> - 금액</li>
            <li><code>#expense_date</code> - 경비 발생일</li>
            <li><code>#cost_center</code> - 코스트 센터</li>
            <li>추가 필드: 위에서 정의한 필드명을 <code>#필드명</code> 형태로 사용</li>
          </ul>
          <p class="mt-2 text-xs text-gray-500">
            경비 항목에 설명이 입력되지 않았을 때 템플릿을 기반으로 자동 생성됩니다.
          </p>
        </div>
      </div>
    </div>

    <!-- 4. 한도 설정 섹션 -->
    <div class="bg-white shadow-sm rounded-lg p-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">한도 설정</h3>
      <div>
        <%= form.label :limit_amount, "한도 금액", class: "block text-sm font-medium text-gray-700" %>
        <div class="mt-1 space-y-3">
          <%= form.text_field :limit_amount, 
              class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              placeholder: "예: 15000 또는 #구성원 * 15000",
              data: { expense_code_form_target: "limitAmountField" },
              disabled: expense_code.limit_amount.nil? %>
          <label class="inline-flex items-center">
            <%= check_box_tag :no_limit, 
                '1', 
                expense_code.limit_amount.nil?,
                class: "rounded border-gray-300 text-indigo-600 focus:ring-indigo-500",
                data: { 
                  expense_code_form_target: "noLimitCheckbox",
                  action: "change->expense-code-form#toggleLimitAmount" 
                } %>
            <span class="ml-2 text-sm text-gray-700">한도 없음</span>
          </label>
          <div class="p-3 bg-gray-50 rounded-lg text-xs text-gray-500">
            <p class="font-medium mb-1">수식 사용 가능:</p>
            <ul class="list-disc list-inside space-y-0.5">
              <li>고정 금액: <code class="bg-white px-1 py-0.5 rounded">15000</code></li>
              <li>인당 금액: <code class="bg-white px-1 py-0.5 rounded">#구성원 * 15000</code> (구성원 필드 사용 시)</li>
              <li>계산식: <code class="bg-white px-1 py-0.5 rounded">(#count + 1) * 10000</code> (숫자 필드 사용 시)</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- 5. 승인 규칙 섹션 -->
    <% if expense_code.persisted? %>
      <!-- 기존 경비 코드 수정 시에는 별도 섹션에서 관리 -->
    <% else %>
      <!-- 새 경비 코드 생성 시 (폼 데이터로 함께 전송) -->
      <div class="bg-white shadow-sm rounded-lg p-6" data-controller="expense-code-approval">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium text-gray-900">승인 규칙</h3>
          <div id="flash_container" class="ml-4"></div>
        </div>
        
        <div class="space-y-3" data-expense-code-approval-target="rules">
          <!-- JavaScript로 동적 추가될 승인 규칙들 -->
        </div>
        
        <!-- 승인 규칙 추가 UI -->
        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
            <%= select_tag 'new_rule_group_id',
                options_from_collection_for_select(@available_groups, :id, :name),
                include_blank: '승인 그룹 선택',
                class: "rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                data: { expense_code_approval_target: "groupSelect" } %>
            
            <%= text_field_tag 'new_rule_min_amount', nil,
                placeholder: '최소 금액 (선택)',
                class: "rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                data: { expense_code_approval_target: "minAmount" } %>
            
            <%= text_field_tag 'new_rule_max_amount', nil,
                placeholder: '최대 금액 (선택)',
                class: "rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                data: { expense_code_approval_target: "maxAmount" } %>
            
            <div class="flex items-center gap-3">
              <label class="inline-flex items-center">
                <%= check_box_tag 'new_rule_mandatory', '1', false,
                    class: "rounded border-gray-300 text-indigo-600 focus:ring-indigo-500",
                    data: { expense_code_approval_target: "mandatory" } %>
                <span class="ml-2 text-sm text-gray-700">필수</span>
              </label>
              
              <button type="button"
                      class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                      data-action="click->expense-code-approval#addRule">
                <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                추가
              </button>
            </div>
          </div>
        </div>
        
        <div class="mt-3 text-xs text-gray-500">
          <p>승인 규칙은 경비 코드와 함께 저장됩니다.</p>
        </div>
      </div>
    <% end %>
  </div>

  <% if !expense_code.persisted? %>
    <!-- 새 경비 코드 생성 시에만 버튼 영역 표시 -->
    <div class="mt-8 flex justify-end gap-3">
      <%= link_to "취소", admin_expense_codes_path, 
          class: "inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
      <%= form.submit "생성", 
          class: "inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
    </div>
  <% end %>
  
<% end %>