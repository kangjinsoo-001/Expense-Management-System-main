<%= form_with(model: [:admin, attachment_requirement], local: false, 
              data: { controller: "nested-fields" }) do |form| %>
  <% if attachment_requirement.errors.any? %>
    <div class="rounded-md bg-red-50 p-4 mb-6">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">오류가 발생했습니다:</h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc pl-5 space-y-1">
              <% attachment_requirement.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- 기본 정보 -->
  <div class="bg-white shadow-sm rounded-lg mb-6">
    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
      <h3 class="text-lg font-medium text-gray-900">기본 정보</h3>
    </div>
    <div class="px-4 py-5 sm:p-6">
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
        <div>
          <%= form.label :name, "이름", class: "block text-sm font-medium text-gray-700" %>
          <%= form.text_field :name, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", required: true %>
        </div>
        
        <div>
          <%= form.label :position, "순서", class: "block text-sm font-medium text-gray-700" %>
          <%= form.number_field :position, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", min: 0 %>
        </div>
      </div>
      
      <div class="mt-6">
        <%= form.label :description, "설명", class: "block text-sm font-medium text-gray-700" %>
        <%= form.text_area :description, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm", rows: 3 %>
      </div>
      
      <div class="mt-6 grid grid-cols-1 gap-6 sm:grid-cols-2">
        <div>
          <%= form.label :file_types, "허용 파일 형식", class: "block text-sm font-medium text-gray-700" %>
          <span class="text-xs text-gray-500">쉼표로 구분 (예: pdf, jpg, png)</span>
          <%= form.text_field :file_types, 
              value: attachment_requirement.file_types&.join(", "), 
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              placeholder: "비워두면 모든 형식 허용" %>
        </div>
        
        <div>
          <%= form.label :condition_expression, "조건 표현식", class: "block text-sm font-medium text-gray-700" %>
          <span class="text-xs text-gray-500">Ruby 표현식 (선택사항)</span>
          <%= form.text_field :condition_expression, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              placeholder: "예: expense_code.name.include?('출장')" %>
        </div>
      </div>
      
      <div class="mt-6 space-y-4">
        <div class="flex items-center">
          <%= form.check_box :required, class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" %>
          <%= form.label :required, "필수 첨부파일", class: "ml-2 block text-sm text-gray-900" %>
        </div>
        
        <div class="flex items-center">
          <%= form.check_box :active, class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" %>
          <%= form.label :active, "활성화", class: "ml-2 block text-sm text-gray-900" %>
        </div>
      </div>
    </div>
  </div>

  <!-- 분석 규칙 -->
  <div class="bg-white shadow-sm rounded-lg mb-6">
    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 flex justify-between items-center">
      <h3 class="text-lg font-medium text-gray-900">분석 규칙</h3>
      <button type="button" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
              data-action="click->nested-fields#addField"
              data-nested-fields-target="analysisAddButton">
        <svg class="-ml-0.5 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        규칙 추가
      </button>
    </div>
    <div class="px-4 py-5 sm:p-6">
      <div data-nested-fields-target="analysisContainer" class="space-y-4">
        <%= form.fields_for :analysis_rules do |analysis_form| %>
          <%= render 'analysis_rule_fields', form: analysis_form %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- 검증 규칙 -->
  <div class="bg-white shadow-sm rounded-lg mb-6">
    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 flex justify-between items-center">
      <h3 class="text-lg font-medium text-gray-900">검증 규칙</h3>
      <button type="button" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
              data-action="click->nested-fields#addField"
              data-nested-fields-target="validationAddButton">
        <svg class="-ml-0.5 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        규칙 추가
      </button>
    </div>
    <div class="px-4 py-5 sm:p-6">
      <div data-nested-fields-target="validationContainer" class="space-y-4">
        <%= form.fields_for :validation_rules do |validation_form| %>
          <%= render 'validation_rule_fields', form: validation_form %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- 액션 버튼 -->
  <div class="flex justify-between">
    <div class="flex space-x-3">
      <%= form.submit "저장", class: "inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
      <%= link_to "취소", admin_attachment_requirements_path, class: "inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
    </div>
  </div>
<% end %>

<script>
  // 파일 형식 입력 처리
  document.addEventListener('turbo:load', () => {
    const fileTypesInput = document.querySelector('input[name="attachment_requirement[file_types]"]');
    if (fileTypesInput) {
      const form = fileTypesInput.closest('form');
      form.addEventListener('submit', (e) => {
        if (fileTypesInput.value) {
          const types = fileTypesInput.value.split(',').map(t => t.trim()).filter(t => t);
          fileTypesInput.value = types.join(',');
        }
      });
    }
  });
</script>