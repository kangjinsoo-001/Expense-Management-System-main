<%= turbo_frame_tag "closing_dashboard", class: "block" do %>
  <div class="min-h-screen flex flex-col" data-controller="closing-dashboard">
    <!-- 헤더: 월 네비게이션 -->
    <%= render 'shared/month_navigator', 
               year: @year, 
               month: @month,
               view_mode: 'monthly',
               url_helper: :admin_closing_dashboard_index_path,
               additional_params: { organization_id: @selected_organization&.id },
               turbo_frame: "closing_dashboard" %>
    
    <div class="flex flex-1">
      <!-- 좌측: 조직 브라우저 -->
      <div class="w-96 bg-white border-r overflow-y-auto">
        <%= render 'shared/organization_browser',
                   organizations: @managed_organizations,
                   selected_organization: @selected_organization,
                   url_helper: :admin_closing_dashboard_index_path,
                   additional_params: { year: @year, month: @month, include_descendants: params[:include_descendants] || 'true' } %>
      </div>
      
      <!-- 우측: 상세 정보 -->
      <div class="flex-1 overflow-y-auto bg-gray-50">
        <% if @selected_organization %>
          <!-- 요약 정보 카드 -->
          <div class="p-6">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
              <h2 class="text-xl font-semibold mb-4">
                <%= @selected_organization.name %> - <%= @year %>년 <%= @month %>월 경비 마감 현황
              </h2>
              
              <% if @summary %>
                <div id="expense_summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <!-- 전체 인원 -->
                  <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-sm text-gray-600 mb-1">전체 인원</div>
                    <div class="text-2xl font-bold text-gray-900"><%= @summary[:total_members] %>명</div>
                  </div>
                  
                  <!-- 제출률 -->
                  <div class="bg-blue-50 rounded-lg p-4">
                    <div class="text-sm text-blue-600 mb-1">제출률</div>
                    <div class="text-2xl font-bold text-blue-900"><%= @summary[:submission_rate] %>%</div>
                    <div class="text-xs text-blue-600 mt-1">
                      <%= @summary[:total_members] - @summary[:not_created] - @summary[:draft] %> / <%= @summary[:total_members] %>명
                    </div>
                  </div>
                  
                  <!-- 승인률 -->
                  <div class="bg-green-50 rounded-lg p-4">
                    <div class="text-sm text-green-600 mb-1">승인률</div>
                    <div class="text-2xl font-bold text-green-900"><%= @summary[:approval_rate] %>%</div>
                    <div class="text-xs text-green-600 mt-1">
                      <%= @summary[:approved] + @summary[:closed] %> / <%= @summary[:submitted] + @summary[:approval_in_progress] + @summary[:approved] + @summary[:closed] %>명
                    </div>
                  </div>
                  
                  <!-- 마감 완료 -->
                  <div class="bg-purple-50 rounded-lg p-4">
                    <div class="text-sm text-purple-600 mb-1">마감 완료</div>
                    <div class="text-2xl font-bold text-purple-900"><%= @summary[:closed] %>명</div>
                    <div class="text-xs text-purple-600 mt-1">
                      승인 대기: <%= @summary[:approved] %>명
                    </div>
                  </div>
                </div>
                
                <!-- 상태별 상세 현황 -->
                <div id="status_details" class="border-t pt-4">
                  <div class="flex items-center gap-4 text-sm">
                    <span class="inline-flex items-center">
                      <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                      미작성: <%= @summary[:not_created] %>명
                    </span>
                    <span class="inline-flex items-center">
                      <span class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></span>
                      작성중: <%= @summary[:draft] %>명
                    </span>
                    <span class="inline-flex items-center">
                      <span class="w-3 h-3 bg-blue-400 rounded-full mr-2"></span>
                      제출됨: <%= @summary[:submitted] %>명
                    </span>
                    <span class="inline-flex items-center">
                      <span class="w-3 h-3 bg-indigo-400 rounded-full mr-2"></span>
                      승인중: <%= @summary[:approval_in_progress] %>명
                    </span>
                    <span class="inline-flex items-center">
                      <span class="w-3 h-3 bg-green-400 rounded-full mr-2"></span>
                      승인완료: <%= @summary[:approved] %>명
                    </span>
                    <span class="inline-flex items-center">
                      <span class="w-3 h-3 bg-purple-400 rounded-full mr-2"></span>
                      마감완료: <%= @summary[:closed] %>명
                    </span>
                  </div>
                </div>
              <% end %>
            </div>
            
            <!-- 구성원 상태 테이블 -->
            <div class="bg-white rounded-lg shadow">
              <div class="p-6 border-b">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-semibold">구성원 경비 제출 현황</h3>
                  <div class="flex gap-2">
                    <button type="button"
                            data-action="click->closing-dashboard#refreshMembers"
                            class="px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">
                      새로고침
                    </button>
                    <button type="button"
                            data-action="click->closing-dashboard#openBatchCloseModal"
                            class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-md transition-colors font-medium">
                      <span data-closing-dashboard-target="selectedCount" class="mr-1"></span>
                      일괄 마감
                    </button>
                    <%= link_to "엑셀 내보내기",
                                export_admin_closing_dashboard_index_path(
                                  organization_id: @selected_organization.id,
                                  year: @year,
                                  month: @month,
                                  include_descendants: params[:include_descendants]
                                ),
                                class: "px-3 py-1.5 text-sm bg-gray-600 text-white hover:bg-gray-700 rounded-md transition-colors" %>
                  </div>
                </div>
                
                <!-- 필터 및 검색 -->
                <div class="flex gap-4">
                  <!-- 상태 필터 -->
                  <select data-action="change->closing-dashboard#filterByStatus"
                          data-closing-dashboard-target="statusFilter"
                          class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                    <option value="">모든 상태</option>
                    <option value="not_created">미작성</option>
                    <option value="draft">작성중</option>
                    <option value="submitted">제출됨</option>
                    <option value="approval_in_progress">승인중</option>
                    <option value="approved">승인완료</option>
                    <option value="closed">마감완료</option>
                  </select>
                  
                  <!-- 검색 -->
                  <div class="flex-1">
                    <input type="text"
                           data-action="input->closing-dashboard#searchMembers"
                           data-closing-dashboard-target="searchInput"
                           placeholder="이름 또는 사번으로 검색..."
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                  </div>
                </div>
              </div>
              
              <!-- 구성원 목록 (AJAX로 로드) -->
              <%= turbo_frame_tag "member_statuses", 
                                  src: organization_members_admin_closing_dashboard_index_path(
                                    organization_id: @selected_organization.id,
                                    year: @year,
                                    month: @month,
                                    include_descendants: params[:include_descendants]
                                  ),
                                  loading: "lazy" do %>
                <div class="p-6">
                  <div class="flex justify-center items-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="ml-3 text-gray-600">데이터를 불러오는 중...</span>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% else %>
          <!-- 조직 미선택 상태 -->
          <div class="flex items-center justify-center h-full">
            <div class="text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              <h3 class="mt-2 text-sm font-medium text-gray-900">조직을 선택하세요</h3>
              <p class="mt-1 text-sm text-gray-500">좌측에서 관리할 조직을 선택하면 경비 마감 현황을 확인할 수 있습니다.</p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
